<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Graph RAG Agent</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <h1>Graph RAG Agent</h1>
                <span class="current-project" id="currentProjectIndicator">æœªé€‰æ‹©é¡¹ç›®</span>
            </div>
            <button class="btn-primary" onclick="showCreateProjectModal()">+ æ–°å»ºé¡¹ç›®</button>
        </header>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Left Panel: Project & Document -->
            <aside class="panel left-panel">
                <div class="panel-tabs">
                    <button class="tab-btn active" data-tab="projects" onclick="switchTab('projects')">é¡¹ç›®ç©ºé—´</button>
                    <button class="tab-btn" data-tab="upload" onclick="switchTab('upload')">æ–‡æ¡£ä¸Šä¼ </button>
                </div>

                <!-- Projects Tab -->
                <div class="tab-content active" id="tab-projects">
                    <div class="project-list" id="projectList">
                        <div class="no-projects">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åˆ›å»ºé¡¹ç›®</div>
                    </div>
                </div>

                <!-- Upload Tab -->
                <div class="tab-content" id="tab-upload">
                    <div class="upload-area" id="dropZone">
                        <div class="upload-icon">ğŸ“„</div>
                        <p>æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</p>
                        <p class="upload-hint">æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
                        <p class="file-types">æ”¯æŒ PDFã€DOCã€DOCXã€TXT</p>
                        <input type="file" id="fileInput" accept=".pdf,.doc,.docx,.txt" hidden>
                    </div>

                    <div id="uploadProgress" class="upload-progress hidden">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <p id="progressText">å¤„ç†ä¸­...</p>
                    </div>

                    <div id="fileList" class="file-list"></div>

                    <div class="graph-stats" id="graphStats">
                        <h3>å›¾è°±ç»Ÿè®¡</h3>
                        <div class="stat-item">
                            <span class="stat-label">å®ä½“æ•°é‡</span>
                            <span class="stat-value" id="entityCount">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">å…³ç³»æ•°é‡</span>
                            <span class="stat-value" id="relationCount">0</span>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Center Panel: Chat -->
            <main class="panel center-panel">
                <div class="panel-header">
                    <h2>å¯¹è¯</h2>
                    <button id="clearChat" class="btn-text">æ¸…ç©ºå¯¹è¯</button>
                </div>
                <div class="chat-messages" id="chatMessages">
                    <div class="message bot">
                        <div class="message-avatar">ğŸ¤–</div>
                        <div class="message-content">
                            <p>ä½ å¥½ï¼æˆ‘æ˜¯ Graph RAG Agentã€‚</p>
                            <p>è¯·å…ˆé€‰æ‹©æˆ–åˆ›å»ºä¸€ä¸ªé¡¹ç›®ï¼Œç„¶åä¸Šä¼ æ–‡æ¡£æ„å»ºçŸ¥è¯†å›¾è°±ã€‚</p>
                            <p>æˆ‘å¯ä»¥åŸºäºçŸ¥è¯†å›¾è°±å›ç­”é—®é¢˜ï¼Œä¹Ÿå¯ä»¥è¿›è¡Œæ—¥å¸¸é—²èŠã€‚</p>
                        </div>
                    </div>
                </div>
                <div class="chat-input-area">
                    <textarea id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="1"></textarea>
                    <button id="sendBtn" class="btn-primary">
                        <span>å‘é€</span>
                    </button>
                </div>
            </main>

            <!-- Right Panel: Graph Visualization -->
            <aside class="panel right-panel">
                <div class="panel-header">
                    <h2>çŸ¥è¯†å›¾è°±</h2>
                    <div class="graph-actions">
                        <button id="toggleEditMode" class="btn-text">ç¼–è¾‘æ¨¡å¼</button>
                        <button id="addNodeBtn" class="btn-text" style="display:none;">+ æ·»åŠ èŠ‚ç‚¹</button>
                        <button id="refreshGraph" class="btn-text">åˆ·æ–°</button>
                    </div>
                </div>
                <div class="panel-content graph-container">
                    <div id="graphChart" class="graph-chart"></div>

                    <!-- Node Detail Panel -->
                    <div id="nodeDetail" class="node-detail hidden">
                        <h3>èŠ‚ç‚¹è¯¦æƒ…</h3>
                        <div id="nodeContent"></div>
                        <button id="closeNodeDetail" class="btn-text">å…³é—­</button>
                    </div>

                    <!-- Edge Detail Panel -->
                    <div id="edgeDetail" class="node-detail hidden">
                        <h3>è¾¹è¯¦æƒ…</h3>
                        <div id="edgeContent"></div>
                        <div class="edge-actions">
                            <button id="editEdgeBtn" class="btn-primary">ç¼–è¾‘</button>
                            <button id="deleteEdgeBtn" class="btn-danger">åˆ é™¤</button>
                            <button id="closeEdgeDetail" class="btn-text" style="margin-left: 8px;">å…³é—­</button>
                        </div>
                    </div>

                    <!-- Edit Form -->
                    <div id="editForm" class="node-detail hidden">
                        <h3 id="editFormTitle">ç¼–è¾‘èŠ‚ç‚¹</h3>
                        <input type="hidden" id="editNodeId">
                        <div class="form-group">
                            <label>åç§°</label>
                            <input type="text" id="editNodeName" placeholder="å®ä½“åç§°">
                        </div>
                        <div class="form-group">
                            <label>ç±»å‹</label>
                            <input type="text" id="editNodeType" placeholder="å¦‚: PERSON, LOC, ORG">
                        </div>
                        <div class="form-group">
                            <label>æè¿°</label>
                            <textarea id="editNodeDescription" rows="3" placeholder="å®ä½“æè¿°"></textarea>
                        </div>
                        <div class="form-actions">
                            <button id="saveEntityBtn" class="btn-primary">ä¿å­˜</button>
                            <button id="closeEditForm" class="btn-text">å–æ¶ˆ</button>
                        </div>
                    </div>

                    <!-- Edge Edit Form -->
                    <div id="edgeEditForm" class="node-detail hidden">
                        <h3 id="edgeEditFormTitle">ç¼–è¾‘è¾¹</h3>
                        <input type="hidden" id="editEdgeSource">
                        <input type="hidden" id="editEdgeTarget">
                        <div class="form-group">
                            <label>æºèŠ‚ç‚¹</label>
                            <input type="text" id="editEdgeSourceName" disabled>
                        </div>
                        <div class="form-group">
                            <label>ç›®æ ‡èŠ‚ç‚¹</label>
                            <input type="text" id="editEdgeTargetName" disabled>
                        </div>
                        <div class="form-group">
                            <label>å…³ç³»ç±»å‹</label>
                            <input type="text" id="editEdgeRelation" placeholder="å¦‚: æœ‹å‹, å±äº, ä½äº">
                        </div>
                        <div class="form-group">
                            <label>æè¿°</label>
                            <textarea id="editEdgeDescription" rows="2" placeholder="å…³ç³»æè¿°"></textarea>
                        </div>
                        <div class="form-group">
                            <label>åŸå§‹åŸæ–‡</label>
                            <div id="edgeSourceText" class="source-text-preview"></div>
                        </div>
                        <div class="form-actions">
                            <button id="saveEdgeBtn" class="btn-primary">ä¿å­˜</button>
                            <button id="closeEdgeEditForm" class="btn-text">å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <!-- Create Project Modal -->
    <div id="createProjectModal" class="modal hidden">
        <div class="modal-content">
            <h3>æ–°å»ºé¡¹ç›®</h3>
            <div class="form-group">
                <label>é¡¹ç›®åç§°</label>
                <input type="text" id="newProjectName" placeholder="è¾“å…¥é¡¹ç›®åç§°">
            </div>
            <div class="form-group">
                <label>é¡¹ç›®æè¿°ï¼ˆå¯é€‰ï¼‰</label>
                <textarea id="newProjectDesc" rows="2" placeholder="è¾“å…¥é¡¹ç›®æè¿°"></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn-primary" onclick="createProject()">åˆ›å»º</button>
                <button class="btn-text" onclick="closeCreateProjectModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="js/api.js"></script>
    <script src="js/chat.js"></script>
    <script src="js/graph.js"></script>
    <script>
        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tabName);
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === 'tab-' + tabName);
            });
        }

        // Create project modal
        function showCreateProjectModal() {
            document.getElementById('createProjectModal').classList.remove('hidden');
            document.getElementById('newProjectName').focus();
        }

        function closeCreateProjectModal() {
            document.getElementById('createProjectModal').classList.add('hidden');
            document.getElementById('newProjectName').value = '';
            document.getElementById('newProjectDesc').value = '';
        }

        async function createProject() {
            const name = document.getElementById('newProjectName').value.trim();
            const description = document.getElementById('newProjectDesc').value.trim();

            if (!name) {
                alert('è¯·è¾“å…¥é¡¹ç›®åç§°');
                return;
            }

            try {
                await window.projectManager.createProject(name, description);
                closeCreateProjectModal();
                switchTab('upload');
            } catch (error) {
                alert('åˆ›å»ºå¤±è´¥: ' + error.message);
            }
        }
    </script>
</body>
</html>
